{"version":3,"sources":["index.js"],"names":["_jsdom","data","require","_fakeTimers","_jestMock","_jestUtil","_defineProperty","obj","key","value","Object","defineProperty","enumerable","configurable","writable","JSDOMEnvironment","config","options","dom","JSDOM","pretendToBeVisual","resources","testEnvironmentOptions","userAgent","ResourceLoader","undefined","runScripts","url","testURL","virtualConsole","VirtualConsole","sendTo","console","global","window","document","defaultView","Error","stackTraceLimit","installCommonGlobals","globals","Buffer","errorEventListener","event","userErrorListenerCount","error","process","emit","addEventListener","originalAddListener","originalRemoveListener","removeEventListener","args","apply","moduleMocker","ModuleMocker","timerConfig","idToRef","id","refToId","ref","fakeTimers","LegacyFakeTimers","fakeTimersModern","ModernFakeTimers","dispose","close","getInternalVMContext","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nfunction _jsdom() {\n  const data = require('jsdom');\n\n  _jsdom = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _fakeTimers() {\n  const data = require('@jest/fake-timers');\n\n  _fakeTimers = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _jestMock() {\n  const data = require('jest-mock');\n\n  _jestMock = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _jestUtil() {\n  const data = require('jest-util');\n\n  _jestUtil = function () {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n  return obj;\n}\n\nclass JSDOMEnvironment {\n  constructor(config, options) {\n    _defineProperty(this, 'dom', void 0);\n\n    _defineProperty(this, 'fakeTimers', void 0);\n\n    _defineProperty(this, 'fakeTimersModern', void 0);\n\n    _defineProperty(this, 'global', void 0);\n\n    _defineProperty(this, 'errorEventListener', void 0);\n\n    _defineProperty(this, 'moduleMocker', void 0);\n\n    this.dom = new (_jsdom().JSDOM)('<!DOCTYPE html>', {\n      pretendToBeVisual: true,\n      resources:\n        typeof config.testEnvironmentOptions.userAgent === 'string'\n          ? new (_jsdom().ResourceLoader)({\n              userAgent: config.testEnvironmentOptions.userAgent\n            })\n          : undefined,\n      runScripts: 'dangerously',\n      url: config.testURL,\n      virtualConsole: new (_jsdom().VirtualConsole)().sendTo(\n        (options === null || options === void 0 ? void 0 : options.console) ||\n          console\n      ),\n      ...config.testEnvironmentOptions\n    });\n    const global = (this.global = this.dom.window.document.defaultView);\n\n    if (!global) {\n      throw new Error('JSDOM did not return a Window object');\n    } // for \"universal\" code (code should use `globalThis`)\n\n    global.global = global; // Node's error-message stack size is limited at 10, but it's pretty useful\n    // to see more than that when a test fails.\n\n    this.global.Error.stackTraceLimit = 100;\n    (0, _jestUtil().installCommonGlobals)(global, config.globals); // TODO: remove this ASAP, but it currently causes tests to run really slow\n\n    global.Buffer = Buffer; // Report uncaught errors.\n\n    this.errorEventListener = event => {\n      if (userErrorListenerCount === 0 && event.error) {\n        process.emit('uncaughtException', event.error);\n      }\n    };\n\n    global.addEventListener('error', this.errorEventListener); // However, don't report them as uncaught if the user listens to 'error' event.\n    // In that case, we assume the might have custom error handling logic.\n\n    const originalAddListener = global.addEventListener;\n    const originalRemoveListener = global.removeEventListener;\n    let userErrorListenerCount = 0;\n\n    global.addEventListener = function (...args) {\n      if (args[0] === 'error') {\n        userErrorListenerCount++;\n      }\n\n      return originalAddListener.apply(this, args);\n    };\n\n    global.removeEventListener = function (...args) {\n      if (args[0] === 'error') {\n        userErrorListenerCount--;\n      }\n\n      return originalRemoveListener.apply(this, args);\n    };\n\n    this.moduleMocker = new (_jestMock().ModuleMocker)(global);\n    const timerConfig = {\n      idToRef: id => id,\n      refToId: ref => ref\n    };\n    this.fakeTimers = new (_fakeTimers().LegacyFakeTimers)({\n      config,\n      global: global,\n      moduleMocker: this.moduleMocker,\n      timerConfig\n    });\n    this.fakeTimersModern = new (_fakeTimers().ModernFakeTimers)({\n      config,\n      global: global\n    });\n  }\n\n  async setup() {}\n\n  async teardown() {\n    if (this.fakeTimers) {\n      this.fakeTimers.dispose();\n    }\n\n    if (this.fakeTimersModern) {\n      this.fakeTimersModern.dispose();\n    }\n\n    if (this.global) {\n      if (this.errorEventListener) {\n        this.global.removeEventListener('error', this.errorEventListener);\n      } // Dispose \"document\" to prevent \"load\" event from triggering.\n\n      Object.defineProperty(this.global, 'document', {\n        value: null\n      });\n      this.global.close();\n    }\n\n    this.errorEventListener = null; // @ts-expect-error\n\n    this.global = null;\n    this.dom = null;\n    this.fakeTimers = null;\n    this.fakeTimersModern = null;\n  }\n\n  getVmContext() {\n    if (this.dom) {\n      return this.dom.getInternalVMContext();\n    }\n\n    return null;\n  }\n}\n\nmodule.exports = JSDOMEnvironment;\n"]}